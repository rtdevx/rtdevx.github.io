{{ if .Params.showPagination | default (.Site.Params.article.showPagination | default true) }}

  {{/* ==========================================================
       STEP 1 — PREPARE NORMALIZED TAGS & CATEGORIES
     ========================================================== */}}

  {{/* Normalize tags */}}
  {{ $tags := .Params.tags }}
  {{ if $tags }}
    {{ if not (reflect.IsSlice $tags) }}
      {{ $tags = slice $tags }}
    {{ end }}
  {{ else }}
    {{ $tags = slice }}
  {{ end }}

  {{/* Normalize categories */}}
  {{ $cats := .Params.categories }}
  {{ if $cats }}
    {{ if not (reflect.IsSlice $cats) }}
      {{ $cats = slice $cats }}
    {{ end }}
  {{ else }}
    {{ $cats = slice }}
  {{ end }}

  {{ $topics := union $tags $cats }}

  {{/* ==========================================================
       STEP 2 — DETERMINE NAVIGATION LIST (SMART FALLBACK)
       Priority:
         1. Series
         2. Topic-aware
         3. Global
     ========================================================== */}}

  {{ $navList := slice }}
  {{ $mode := "" }}

  {{/* ---------- 1️⃣ SERIES MODE ---------- */}}
  {{ if .Params.series }}
    {{ $series := .Params.series }}
    {{ $seriesPosts := where site.RegularPages "Params.series" $series }}
    {{ $seriesPosts := where $seriesPosts "Params.externalUrl" "==" nil }}

    {{/* Check if any post has series_order */}}
    {{ $hasOrder := false }}
    {{ range $seriesPosts }}
      {{ if .Params.series_order }}
        {{ $hasOrder = true }}
      {{ end }}
    {{ end }}

    {{/* Sort series posts */}}
    {{ if $hasOrder }}
      {{ $seriesPosts = sort $seriesPosts "Params.series_order" "asc" }}
    {{ else }}
      {{ $seriesPosts = sort $seriesPosts "Date" "asc" }}
    {{ end }}

    {{ $navList = $seriesPosts }}
    {{ $mode = "series" }}
  {{ end }}

  {{/* ---------- 2️⃣ TOPIC-AWARE MODE ---------- */}}
  {{ if and (eq $mode "") (gt (len $topics) 0) }}
    {{ $posts := where site.RegularPages "Section" "posts" }}
    {{ $posts := where $posts "Params.externalUrl" "==" nil }}

    {{ $topicMatches := slice }}

    {{ range $p := $posts }}
      {{/* Normalize p.tags */}}
      {{ $pTags := $p.Params.tags }}
      {{ if $pTags }}
        {{ if not (reflect.IsSlice $pTags) }}
          {{ $pTags = slice $pTags }}
        {{ end }}
      {{ else }}
        {{ $pTags = slice }}
      {{ end }}

      {{/* Normalize p.categories */}}
      {{ $pCats := $p.Params.categories }}
      {{ if $pCats }}
        {{ if not (reflect.IsSlice $pCats) }}
          {{ $pCats = slice $pCats }}
        {{ end }}
      {{ else }}
        {{ $pCats = slice }}
      {{ end }}

      {{ $pTopics := union $pTags $pCats }}

      {{ if gt (len (intersect $topics $pTopics)) 0 }}
        {{ $topicMatches = $topicMatches | append $p }}
      {{ end }}
    {{ end }}

    {{ if gt (len $topicMatches) 0 }}
      {{ $navList = sort $topicMatches "Date" "desc" }}
      {{ $mode = "topics" }}
    {{ end }}
  {{ end }}

  {{/* ---------- 3️⃣ GLOBAL FALLBACK ---------- */}}
  {{ if eq $mode "" }}
    {{ $global := where site.RegularPages "Section" "posts" }}
    {{ $global := where $global "Params.externalUrl" "==" nil }}
    {{ $navList = sort $global "Date" "desc" }}
    {{ $mode = "global" }}
  {{ end }}

  {{/* ==========================================================
       STEP 3 — FIND CURRENT INDEX + PREV/NEXT
     ========================================================== */}}

  {{ $current := . }}
  {{ $index := -1 }}

  {{ range $i, $p := $navList }}
    {{ if eq $p $current }}
      {{ $index = $i }}
    {{ end }}
  {{ end }}

  {{ if ge $index 0 }}
    {{ $lastIndex := sub (len $navList) 1 }}
    {{ $prev := cond (gt (add $index 1) $lastIndex) nil (index $navList (add $index 1)) }}
    {{ $next := cond (lt (sub $index 1) 0) nil (index $navList (sub $index 1)) }}

    {{/* Respect invertPagination */}}
    {{ if .Params.invertPagination | default (.Site.Params.article.invertPagination | default false) }}
      {{ $tmp := $next }}
      {{ $next = $prev }}
      {{ $prev = $tmp }}
    {{ end }}

    {{/* ========================================================
         STEP 4 — RENDER EXACTLY ONE NAVIGATION BLOCK
         Only if prev or next exists
       ======================================================== */}}

    {{ if or $prev $next }}
      <div class="pt-8">
        <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
        <div class="flex justify-between pt-3">

          <span>
            {{ if $prev }}
              <a class="group flex" href="{{ $prev.Permalink }}">
                <span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400">
                  <span class="ltr:inline rtl:hidden">&larr;</span>
                  <span class="ltr:hidden rtl:inline">&rarr;</span>
                </span>
                <span class="flex flex-col">
                  <span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">
                    {{ $prev.Title | emojify }}
                  </span>
                  <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                    {{ partial "meta/date.html" $prev.Date }}
                  </span>
                </span>
              </a>
            {{ end }}
          </span>

          <span>
            {{ if $next }}
              <a class="group flex text-right" href="{{ $next.Permalink }}">
                <span class="flex flex-col">
                  <span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">
                    {{ $next.Title | emojify }}
                  </span>
                  <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                    {{ partial "meta/date.html" $next.Date }}
                  </span>
                </span>
                <span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[-2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400">
                  <span class="ltr:inline rtl:hidden">&rarr;</span>
                  <span class="ltr:hidden rtl:inline">&larr;</span>
                </span>
              </a>
            {{ end }}
          </span>

        </div>
      </div>
    {{ end }}
  {{ end }}

{{ end }}